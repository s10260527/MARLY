<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Verdex | Dashboard</title>
  <link rel="icon" type="image/x-icon" href="assets/brand/logo.png" />

  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <!-- Bootstrap Icons -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
  />
  <!-- External CSS -->
  <link rel="stylesheet" href="styles/dashboard.css" />
  <link rel="stylesheet" href="styles/emissions-graph.css" />
  <link rel="stylesheet" href="styles/energy-consumption-graph.css" />
  <link rel="stylesheet" href="styles/operational-costs-graph.css" />
  <link rel="stylesheet" href="styles/month-picker.css" />
  <link rel="stylesheet" href="styles/general-graph.css" />

  <!-- Chart.js (for graphs) -->
  <script
    src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js">
  </script>
  <!-- jQuery -->
  <script
    src="https://code.jquery.com/jquery-3.6.0.min.js">
  </script>

  <!-- Poppins Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;200;300;400;500;600;700;800;900&display=swap"
    rel="stylesheet"
  />
</head>

<body>
  <div class="d-flex">
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar-toggle">
      <div class="sidebar-logo">
        <img
          src="assets/brand/logo.png"
          alt="Verdex Logo"
          width="30"
          height="30"
        />
        <a href="#">Verdex</a>
      </div>

      <ul class="sidebar-nav p-0">
        <div class="sidebar-header">
          <hr />
        </div>
        <li class="sidebar-item">
          <a href="dashboard.html" class="sidebar-link">
            <i class="bi bi-pie-chart-fill"></i>
            <span>Dashboard</span>
          </a>
        </li>
        <li class="sidebar-item">
          <a href="report.html" class="sidebar-link">
            <i class="bi bi-clipboard-data-fill"></i>
            <span>Reports</span>
          </a>
        </li>
        <li class="sidebar-item">
          <a href="campaign.html" class="sidebar-link">
            <i class="bi bi-megaphone-fill"></i>
            <span>Campaigns</span>
          </a>
        </li>
        <div class="sidebar-header">
          <hr />
        </div>
        <li class="sidebar-item user">
          <!-- Dynamically update company name here -->
          <a href="profile.html" class="sidebar-link user-profile">
            <div class="user-info">
              <img
                src="assets/images/user-avatar.png"
                alt="User Avatar"
              />
              <!-- Updated with JS -->
              <p id="sidebarCompanyName">Loading...</p>
            </div>
          </a>
        </li>
        <li class="sidebar-item progress-net">
          <div class="sidebar-link">
            <span><b>Progress to Net Zero</b></span>
            <i class="bi bi-globe-americas"></i>
            <p></p>
            <div
              class="progress"
              role="progressbar"
              aria-label="Animated striped example"
              aria-valuenow="75"
              aria-valuemin="0"
              aria-valuemax="100"
            >
              <div
                class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                style="width: 75%"
              ></div>
            </div>
            <p></p>
            <p><b>75%</b> of goal reached</p>
          </div>
        </li>
      </ul>

      <div class="sidebar-footer">
        <a href="#" class="sidebar-link">
          <i class="bi bi-person-raised-hand"></i>
          <span>About Us</span>
        </a>
      </div>
    </aside>
    <!-- Sidebar Ends -->

    <!-- Main Component -->
    <div class="main">
      <!-- Month Picker -->
      <div class="picker-container">
        <div class="date-input-container">
          <i class="bi bi-calendar3 calendar-icon"></i>
          <input
            type="text"
            class="date-input"
            id="monthRange"
            placeholder="MM/YYYY - MM/YYYY"
          />
        </div>

        <div class="overlay" id="overlay"></div>

        <div class="picker-dropdown" id="pickerDropdown">
          <div class="picker-header">
            <i class="bi bi-calendar3"></i>
            <span id="selectedRange">Select date range</span>
          </div>
          <div class="picker-content">
            <div class="calendar-section">
              <div class="years-container">
                <div class="year-grid">
                  <div class="year-header">
                    <button class="year-nav-btn" id="prevYear2024">
                      <i class="bi bi-chevron-left"></i>
                    </button>
                    <span>2024</span>
                    <button class="year-nav-btn" id="nextYear2024">
                      <i class="bi bi-chevron-right"></i>
                    </button>
                  </div>
                  <div class="month-grid" id="monthGrid2024"></div>
                </div>

                <div class="year-grid">
                  <div class="year-header">
                    <button class="year-nav-btn" id="prevYear2025">
                      <i class="bi bi-chevron-left"></i>
                    </button>
                    <span>2025</span>
                    <button class="year-nav-btn" id="nextYear2025">
                      <i class="bi bi-chevron-right"></i>
                    </button>
                  </div>
                  <div class="month-grid" id="monthGrid2025"></div>
                </div>
              </div>
            </div>

            <div class="presets-section">
              <div class="preset-label">Quick Select</div>
              <div class="presets-list">
                <button class="preset-btn" data-range="this-year">
                  This year
                </button>
                <button class="preset-btn" data-range="last-year">
                  Last year
                </button>
                <button class="preset-btn" data-range="last-6">
                  Last 6 months
                </button>
                <button class="preset-btn" data-range="last-12">
                  Last 12 months
                </button>
              </div>
            </div>
          </div>
          <div class="picker-footer">
            <button class="confirm-btn" id="confirmSelection">
              Confirm Selection
            </button>
          </div>
        </div>
      </div>
      <!-- Month Picker Ends -->

      <!-- Data Glance -->
      <div class="data-glance">
        <!-- Cards that get updated by JS -->
        <div class="card" style="width: 15rem;" id="carbon-emissions-card">
          <div class="card-body">
            <h5 class="card-title">
              <div id="carbonEmissionsValue">0</div> t
            </h5>
            <p class="card-text">Total Carbon Emissions</p>
            <h6 class="card-subtitle mb-2 text-body-secondary"></h6>
            <p class="card-text">This month</p>
            <h6 class="card-subtitle mb-2 text-body-secondary">
              <i class="bi"></i>
            </h6>
          </div>
        </div>

        <div class="card" style="width: 15rem;" id="energy-consumption-card">
          <div class="card-body">
            <h5 class="card-title">
              <div id="energyConsumptionValue">0</div> kWh
            </h5>
            <p class="card-text">Total Energy Consumption</p>
            <h6 class="card-subtitle mb-2 text-body-secondary"></h6>
            <p class="card-text">This month</p>
            <h6 class="card-subtitle mb-2 text-body-secondary">
              <i class="bi"></i>
            </h6>
          </div>
        </div>

        <div class="card" style="width: 15rem;" id="operational-costs-card">
          <div class="card-body">
            <h5 class="card-title">
              $<div id="operationalCostsValue">0</div>
              <span></span>
            </h5>
            <p class="card-text">Total Operational Costs</p>
            <h6 class="card-subtitle mb-2 text-body-secondary"></h6>
            <p class="card-text">This month</p>
            <h6 class="card-subtitle mb-2 text-body-secondary">
              <i class="bi"></i>
            </h6>
          </div>
        </div>
      </div>
      <!-- Data Glance Ends -->

      <!-- Suggestions Facts -->
      <div class="suggest-facts">
        <h6>üîç Data Insights</h6>
        <div class="card">
          <div class="card-body">
            <p class="card-text">
              Your <br /><b>Total Carbon Emissions</b>
              <br />is equivalent to
            </p>
            <p class="card-text multiply">
              <img
                src="assets/images/car.png"
                alt="Car Icon"
                height="40"
                width="40"
              />
              <span id="car-equivalent"></span>
            </p>
            <p class="card-text multiply-info">
              <em>(4-seater car driven for 100 km)</em>
            </p>
          </div>
        </div>
        <div class="card">
          <div class="card-body">
            <p class="card-text">
              Your <br /><b>Total Energy Consumption</b>
              <br />is equivalent to
            </p>
            <p class="card-text multiply">
              <img
                src="assets/images/house.png"
                alt="House Icon"
                height="40"
                width="40"
              />
              <span id="hdb-equivalent"></span>
            </p>
            <p class="card-text multiply-info">
              <em>(4-room HDB flat powered for 1 year 24/7)</em>
            </p>
          </div>
        </div>
        <h6>üí° AI Suggestions</h6>
        <div class="suggestions-container">
          <div class="suggestion-card">
            <h3 class="suggestion-title">Carbon Emissions</h3>
            <div class="suggestion-item">
              <div class="suggestion-number">1</div>
              <div class="suggestion-content">
                <h4>Invest in Energy Efficiency</h4>
                <ul class="suggestion-list">
                  <li>
                    Upgrade equipment: Replace outdated machinery with
                    energy-efficient models
                  </li>
                  <li>
                    Optimize lighting: Install LED lights and utilize
                    natural light whenever possible
                  </li>
                </ul>
              </div>
            </div>
          </div>

          <div class="suggestion-card">
            <h3 class="suggestion-title">Operational Costs</h3>
            <div class="suggestion-item">
              <div class="suggestion-number">1</div>
              <div class="suggestion-content">
                <h4>Optimize Supply Chain</h4>
                <ul class="suggestion-list">
                  <li>
                    Negotiate better deals: Work with suppliers to secure
                    competitive pricing and terms
                  </li>
                </ul>
              </div>
            </div>
            <div class="suggestion-item">
              <div class="suggestion-number">2</div>
              <div class="suggestion-content">
                <h4>Automate Processes</h4>
                <ul class="suggestion-list">
                  <li>
                    Invest in technology: Utilize software and tools to
                    streamline operations and reduce manual labor
                  </li>
                  <li>
                    Train employees: Ensure staff is adequately trained to
                    use new technologies effectively
                  </li>
                </ul>
              </div>
            </div>
          </div>

          <div class="suggestion-disclaimer">
            *This content was generated with the assistance of
            artificial intelligence. While we strive for relevance and
            accuracy, please note that AI-generated content may not
            always reflect the most current legal standards or
            personalized advice.
          </div>
        </div>
      </div>
      <!-- Suggestions Facts Ends -->

      <!-- General Graph -->
      <div class="general-graph">
        <h6>General Graph</h6>
        <div class="card">
          <div class="card-body">
            <div class="chart-container">
              <canvas id="general-graph"></canvas>
            </div>
          </div>
        </div>
      </div>
      <!-- General Graph Ends -->

      <!-- Detailed Graph -->
      <div class="detailed-graph">
        <h6>Detailed Graph</h6>
        <ul
          class="nav nav-tabs"
          id="detailedGraphTabs"
          role="tablist"
        >
          <li class="nav-item" role="presentation">
            <button
              class="nav-link active"
              id="carbon-tab"
              data-bs-toggle="tab"
              data-bs-target="#carbon"
              type="button"
              role="tab"
              aria-controls="carbon"
              aria-selected="true"
            >
              Carbon Emissions
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button
              class="nav-link"
              id="energy-tab"
              data-bs-toggle="tab"
              data-bs-target="#energy"
              type="button"
              role="tab"
              aria-controls="energy"
              aria-selected="false"
            >
              Energy Consumption
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button
              class="nav-link"
              id="costs-tab"
              data-bs-toggle="tab"
              data-bs-target="#costs"
              type="button"
              role="tab"
              aria-controls="costs"
              aria-selected="false"
            >
              Operational Costs
            </button>
          </li>
        </ul>
        <div class="card">
          <div class="card-body">
            <div
              class="tab-content"
              id="detailedGraphContent"
            >
              <!-- Carbon Emissions Tab -->
              <div
                class="tab-pane fade show active"
                id="carbon"
                role="tabpanel"
                aria-labelledby="carbon-tab"
              >
                <div class="detailed-graph-carbon">
                  <!-- Controls Row -->
                  <div class="controls-row">
                    <div class="controls-left">
                      <button
                        id="backButton"
                        class="btn btn-secondary back-button"
                      >
                        <i class="bi bi-arrow-left"></i> Back
                      </button>
                    </div>
                    <span
                      id="viewIndicator"
                      class="view-indicator"
                    ></span>
                    <div class="controls-right">
                      <button
                        id="netEmissionsToggle"
                        class="btn btn-outline-primary"
                      >
                        Show Net Emissions
                      </button>
                    </div>
                  </div>

                  <!-- Charts Row -->
                  <div class="row charts-row">
                    <!-- Line Graph Section -->
                    <div class="col-lg-8">
                      <h5
                        class="chart-title"
                        id="lineChartTitle"
                      >
                        Carbon Emissions Over Time
                      </h5>
                      <div class="chart-container">
                        <canvas id="emissionsLineChart"></canvas>
                      </div>
                    </div>

                    <!-- Pie Chart Section -->
                    <div class="col-lg-4">
                      <h5
                        class="chart-title"
                        id="pieChartTitle"
                      >
                        Emissions by Sector
                      </h5>
                      <div class="chart-container">
                        <canvas id="sectorPieChart"></canvas>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Energy Consumption Tab -->
              <div
                class="tab-pane fade"
                id="energy"
                role="tabpanel"
                aria-labelledby="energy-tab"
              >
                <div class="detailed-graph-energy">
                  <!-- Controls Row -->
                  <div class="controls-row">
                    <div class="controls-left">
                      <button
                        id="energyBackButton"
                        class="btn btn-secondary back-button"
                      >
                        <i class="bi bi-arrow-left"></i> Back
                      </button>
                    </div>
                    <span
                      id="energyViewIndicator"
                      class="view-indicator"
                    ></span>
                  </div>

                  <!-- Charts Row -->
                  <div class="row charts-row">
                    <!-- Line Graph Section -->
                    <div class="col-lg-8">
                      <h5
                        class="chart-title"
                        id="energyLineChartTitle"
                      >
                        Energy Consumption Over Time
                      </h5>
                      <div class="chart-container">
                        <canvas id="energyLineChart"></canvas>
                      </div>
                    </div>

                    <!-- Pie Chart Section -->
                    <div class="col-lg-4">
                      <h5
                        class="chart-title"
                        id="energyPieChartTitle"
                      >
                        Energy Consumption by Sector
                      </h5>
                      <div class="chart-container">
                        <canvas id="energySectorPieChart"></canvas>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Operational Costs Tab -->
              <div
                class="tab-pane fade"
                id="costs"
                role="tabpanel"
                aria-labelledby="costs-tab"
              >
                <div class="detailed-graph-costs">
                  <!-- Controls Row -->
                  <div class="controls-row">
                    <div class="controls-left">
                      <button
                        id="costsBackButton"
                        class="btn btn-secondary back-button"
                      >
                        <i class="bi bi-arrow-left"></i> Back
                      </button>
                    </div>
                    <span
                      id="costsViewIndicator"
                      class="view-indicator"
                    ></span>
                  </div>

                  <!-- Charts Row -->
                  <div class="row charts-row">
                    <!-- Vertical Bar Graph Section -->
                    <div class="col-lg-8">
                      <h5
                        class="chart-title"
                        id="costsVerticalBarChartTitle"
                      >
                        Operational Costs Over Time
                      </h5>
                      <div class="chart-container">
                        <canvas
                          id="costsVerticalBarChart"
                        ></canvas>
                      </div>
                    </div>

                    <!-- Horizontal Bar Graph Section -->
                    <div class="col-lg-4">
                      <h5
                        class="chart-title"
                        id="costsHorizontalBarChartTitle"
                      >
                        Operational Costs by Sector
                      </h5>
                      <div class="chart-container">
                        <canvas
                          id="costsHorizontalBarChart"
                        ></canvas>
                      </div>
                      <div class="text-center mt-3">
                        <p class="h5">
                          Total: $
                          <span
                            id="costsHorizontalChartTotal"
                          >0</span>
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <!-- Operational Costs Tab Ends -->
            </div>
          </div>
          <!-- Detailed Graph Ends -->

          <!-- Competing Company -->
          <div class="competing-company mt-4"> <!-- Added 'mt-4' for top margin -->
            <div class="card bg-mine">
              <div class="card-body">
                <h3 class="company-head">A Competing Company</h3>
                <div class="d-flex align-items-center gap-3 mb-3">
                  <img
                    src="assets/images/smart-tech-logo.png"
                    alt="SmartTech Corp. Logo"
                    class="rounded-circle"
                    width="60" <!-- Adjusted size for better alignment -->
                    height="60"
                  />
                  <div>
                    <div class="d-flex align-items-center gap-2">
                      <h5 class="mb-0">SmartTech Corp.</h5>
                      <span class="badge bg-mine">Leaderboard #3</span>
                    </div>
                    <div
                      class="progress mt-2"
                      style="height: 8px;"
                    >
                      <div
                        class="progress-bar"
                        role="progressbar"
                        style="width: 75%;"
                        aria-valuenow="75"
                        aria-valuemin="0"
                        aria-valuemax="100"
                      ></div>
                    </div>
                    <small class="text-muted"
                      >Progress to Net Zero Goal ‚ôªÔ∏è (80%)</small
                    >
                  </div>
                </div>

                <div class="content-wrapper">
                  <p class="small company-desc">
                    We‚Äôve been innovating and advancing technology focused
                    on the connections that matter since we invented the
                    original SMART Board¬Æ in 1987. We‚Äôre proud that our
                    interactive displays and software solutions are trusted
                    by teachers, students, and business leaders all around
                    the world.
                  </p>

                  <div class="company-stats">
                    <div class="stat-block">
                      <h4 class="h2 mb-0">3</h4>
                      <small class="text-muted"
                        >Total Devices Recycled<br />
                        (Nov 2024)</small
                      >
                      <br />
                      <small class="text-primary">2 Mobiles</small>,
                      <small class="text-secondary">1 Desktop</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div> <!-- End Competing Company -->
        </div> <!-- End .main -->
      </div> <!-- End .d-flex -->

      <!-- Bootstrap Bundle JS -->
      <script
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js">
      </script>

      <!-- External Scripts (Month Picker, Graphs, etc.) -->
      <script src="scripts/month-picker.js"></script>
      <script src="scripts/general-graph.js"></script>
      <script src="scripts/emissions-graph.js"></script>
      <script src="scripts/energy-consumption-graph.js"></script>
      <script src="scripts/operational-costs-graph.js"></script>

      <!-- The main dashboard script that fetches data from the server -->
      <script>
        // 1) Helper to parse JWT tokens (if needed)
        function parseJwt(token) {
          try {
            const base64Url = token.split(".")[1];
            const base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
            return JSON.parse(window.atob(base64));
          } catch (e) {
            console.error("Error parsing JWT:", e);
            return null;
          }
        }

        // 2) On document ready
        $(document).ready(function () {
          const token = localStorage.getItem("token");
          if (!token) {
            alert("No token found. Please log in.");
            window.location.href = "login.html";
            return;
          }

          // Optionally decode token for debugging
          const decoded = parseJwt(token);
          console.log("Decoded JWT:", decoded);

          // ---- 2.1) Fetch top-level data for the 3 cards ----
          $.ajax({
            type: "GET",
            url: "/api/dashboard/data",
            headers: {
              Authorization: `Bearer ${token}`,
            },
            success: function (response) {
              console.log("Top-level data:", response);

              // Sidebar company name
              $("#sidebarCompanyName").text(response.companyName);

              // Card: Carbon Emissions
              $("#carbonEmissionsValue").text(
                parseFloat(response.totalEmissions || 0).toFixed(2)
              );

              // Card: Energy Consumption
              $("#energyConsumptionValue").text(
                parseFloat(response.totalEnergyConsumption || 0).toFixed(2)
              );

              // Card: Operational Costs
              $("#operationalCostsValue").text(
                parseFloat(response.totalOperationalCosts || 0).toFixed(2)
              );

              // Example of "Insights" logic (just a placeholder):
              // Suppose 1 ton of CO2 = 3.5 "car equivalents" (random example)
              const carEquivalent =
                Math.round((response.totalEmissions || 0) * 3.5) || 0;
              $("#car-equivalent").text(`${carEquivalent} cars`);

              // Suppose 1 kWh = 0.0005 "HDB-equivalents" (random example)
              const hdbEquivalent =
                Math.round((response.totalEnergyConsumption || 0) * 0.0005) || 0;
              $("#hdb-equivalent").text(`${hdbEquivalent} HDB flats`);
            },
            error: function (xhr) {
              console.error("Error fetching top-level data:", xhr);
              if (xhr.status === 401) {
                window.location.href = "login.html";
              } else {
                alert("Error loading dashboard data. Please try again.");
              }
            },
          });

          // ---- 2.2) Fetch paginated data for charts, if needed ----
          // The following is an example for a line chart (Carbon Emissions Over Time).
          // This depends on how your `emissions-graph.js` or other scripts are structured.
          // If they already do their own fetch, you can skip or adapt.

          fetchPaginatedDataForCharts(token);
        });

        // Example function to fetch data for charts
        function fetchPaginatedDataForCharts(token) {
          const limit = 50; // or however many months you'd like
          const offset = 0;

          // GET /api/dashboard/data/paginated?limit=...&offset=...
          $.ajax({
            type: "GET",
            url: `/api/dashboard/data/paginated?limit=${limit}&offset=${offset}`,
            headers: { Authorization: `Bearer ${token}` },
            success: (response) => {
              console.log("Paginated data for charts:", response.data);
              
              // You can transform this data to build your chart.js datasets
              // For example, build arrays for the line chart:
              const dates = [];
              const emissionsData = [];
              const energyData = [];
              const costData = [];

              response.data.forEach((row) => {
                if (row.emission_date) {
                  const dateObj = new Date(row.emission_date);
                  const labelStr = `${
                    dateObj.getMonth() + 1
                  }/${dateObj.getFullYear()}`;

                  dates.push(labelStr);
                  emissionsData.push(parseFloat(row.emissions || 0));
                  energyData.push(parseFloat(row.energy || 0));
                  costData.push(parseFloat(row.costs || 0));
                }
              });

              // Now pass these to your existing chart scripts:
              updateCarbonEmissionsLineChart(dates, emissionsData);
              updateEnergyConsumptionLineChart(dates, energyData);
              updateOperationalCostsBarChart(dates, costData);
            },
            error: (xhr) => {
              console.error("Error fetching paginated data:", xhr);
            },
          });
        }

        // If needed, these are stubs that your external scripts (emissions-graph.js, etc.) might define:
        function updateCarbonEmissionsLineChart(labels, data) {
          // For example, if emissionsLineChart is a global Chart object:
          // emissionsLineChart.data.labels = labels;
          // emissionsLineChart.data.datasets[0].data = data;
          // emissionsLineChart.update();
          console.log("Should update Carbon Emissions chart with:", labels, data);
        }

        function updateEnergyConsumptionLineChart(labels, data) {
          console.log("Should update Energy Consumption chart with:", labels, data);
        }

        function updateOperationalCostsBarChart(labels, data) {
          console.log("Should update Operational Costs chart with:", labels, data);
        }
      </script>
    </body>
</html>
